{% extends "base.html" %}
{% block container_class %}container-fluid{% endblock %}
{% block content %}
  {% if view == "login" %}
    <div class="row justify-content-center">
      <div class="col-md-5 col-lg-4">
        <div class="form-section">
          <h1>Acceso Administrativo</h1>
          <p class="text-center text-muted mb-4">Ingrese sus credenciales para acceder al panel de control</p>
          
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for cat, msg in messages %}
                <div class="alert alert-{{ 'danger' if cat == 'error' else cat }}">
                  <i class="fas fa-{{ 'exclamation-circle' if cat == 'error' else 'check-circle' if cat == 'success' else 'info-circle' }}"></i>
                  {{ msg }}
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}
          
          <form method="post" action="{{ url_for('admin_login_post') }}">
            <div class="mb-3">
              <label class="form-label required">Usuario</label>
              <input class="form-control" name="user" required placeholder="Ingrese su usuario" />
            </div>
            <div class="mb-3">
              <label class="form-label required">Contraseña</label>
              <input type="password" class="form-control" name="password" required placeholder="Ingrese su contraseña" />
            </div>
            <button class="btn btn-primary w-100" type="submit">
              <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión
            </button>
          </form>
        </div>
      </div>
    </div>
    
  {% elif view == "panel" %}
    <!-- Header del Panel -->
    <div class="admin-header mb-4">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h1 class="admin-title">
            <i class="fas fa-dashboard"></i>
            Panel de Control
          </h1>
          <p class="text-muted mb-0">Gestión de eventos y registros de asistencia</p>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
          <a class="btn btn-outline-danger" href="{{ url_for('admin_logout') }}">
            <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
          </a>
        </div>
      </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="row">
          <div class="col-12">
            {% for cat, msg in messages %}
              <div class="alert alert-{{ 'danger' if cat == 'error' else cat }}">
                <i class="fas fa-{{ 'exclamation-circle' if cat == 'error' else 'check-circle' if cat == 'success' else 'info-circle' }}"></i>
                {{ msg }}
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    {% endwith %}

    <!-- Sección: Crear Nuevo Evento -->
    <div class="form-section mb-4">
      <h2 class="section-title">
        <i class="fas fa-calendar-plus"></i>
        Crear Nuevo Evento
      </h2>
      <form class="row g-3" method="post" action="{{ url_for('admin_evento') }}">
        <div class="col-md-4">
          <label class="form-label required">Identificador único (slug)</label>
          <input class="form-control" name="slug" placeholder="ej. conferencia-2025" required 
                 pattern="[a-z0-9-]+" title="Solo letras minúsculas, números y guiones" />
          <small class="text-muted">Solo letras minúsculas, números y guiones</small>
        </div>
        <div class="col-md-8">
          <label class="form-label required">Título del evento</label>
          <input class="form-control" name="titulo" placeholder="Nombre completo del evento" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha de inicio</label>
          <input type="datetime-local" class="form-control" name="fecha_inicio" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha de finalización</label>
          <input type="datetime-local" class="form-control" name="fecha_fin" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Lugar del evento</label>
          <input class="form-control" name="lugar" placeholder="Ubicación o modalidad" />
        </div>
        <div class="col-md-2">
          <label class="form-label d-block">&nbsp;</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="activo" name="activo" />
            <label class="form-check-label" for="activo">
              <i class="fas fa-toggle-on text-success"></i> Evento activo
            </label>
          </div>
        </div>
        <div class="col-12">
          <button class="btn btn-primary" type="submit">
            <i class="fas fa-plus-circle me-2"></i>Crear Evento
          </button>
        </div>
      </form>
    </div>

    <!-- Sección: Gestión de Eventos -->
    <div class="form-section mb-4">
      <h2 class="section-title">
        <i class="fas fa-list"></i>
        Eventos Registrados
      </h2>
      
      <!-- Filtros y Exportación -->
      <div class="filter-section mb-4">
        <form class="row g-3 align-items-end" method="get" action="{{ url_for('admin_panel') }}">
          <div class="col-md-6">
            <label class="form-label">Seleccionar evento para ver registros</label>
            <select class="form-select" name="slug">
              <option value="">— Seleccione un evento —</option>
              {% for e in eventos %}
                <option value="{{ e.slug }}" {% if slug==e.slug %}selected{% endif %}>
                  {{ e.titulo }} ({{ e.slug }})
                  {% if e.activo %}<span class="text-success">● Activo</span>{% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <button class="btn btn-primary w-100" type="submit">
              <i class="fas fa-search me-2"></i>Ver Registros
            </button>
          </div>
          <div class="col-md-3">
            {% if slug %}
            <a class="btn btn-success w-100" href="{{ url_for('admin_export', slug=slug) }}">
              <i class="fas fa-file-csv me-2"></i>Exportar CSV
            </a>
            {% else %}
            <button class="btn btn-success w-100" type="button" disabled>
              <i class="fas fa-file-csv me-2"></i>Exportar CSV
            </button>
            {% endif %}
          </div>
        </form>
      </div>

      <!-- Tabla de Eventos -->
      <div class="table-responsive">
        <table class="table table-hover admin-table">
          <thead>
            <tr>
              <th width="5%">#</th>
              <th width="15%">Identificador</th>
              <th width="25%">Título</th>
              <th width="12%">Fecha Inicio</th>
              <th width="12%">Fecha Fin</th>
              <th width="15%">Lugar</th>
              <th width="8%">Estado</th>
              <th width="8%">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for e in eventos %}
            <tr class="{% if e.activo %}table-active{% endif %}">
              <td>{{ loop.index }}</td>
              <td><code class="event-slug">{{ e.slug }}</code></td>
              <td class="fw-semibold">{{ e.titulo }}</td>
              <td>{{ e.fecha_inicio or '—' }}</td>
              <td>{{ e.fecha_fin or '—' }}</td>
              <td>{{ e.lugar or '—' }}</td>
              <td>
                {% if e.activo %}
                  <span class="badge bg-success">
                    <i class="fas fa-check-circle"></i> Activo
                  </span>
                {% else %}
                  <span class="badge bg-secondary">
                    <i class="fas fa-pause-circle"></i> Inactivo
                  </span>
                {% endif %}
              </td>
              <td>
                {% if e.activo %}
                  <form method="post" action="{{ url_for('admin_evento_desactivar', event_id=e.id) }}" class="d-inline">
                    <button class="btn btn-sm btn-outline-danger" type="submit">
                      <i class="fas fa-stop"></i> Desactivar
                    </button>
                  </form>
                {% else %}
                  <form method="post" action="{{ url_for('admin_evento_activar', event_id=e.id) }}" class="d-inline">
                    <button class="btn btn-sm btn-outline-success" type="submit">
                      <i class="fas fa-play"></i> Activar
                    </button>
                  </form>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                <i class="fas fa-calendar-times fa-2x mb-2"></i>
                <p>No hay eventos creados aún</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Sección: Registros de Asistencia -->
    {% if slug %}
    <div class="form-section">
      <h2 class="section-title">
        <i class="fas fa-users"></i>
        Registros de Asistencia
        <span class="badge bg-primary ms-2">{{ registros|length }} registros</span>
      </h2>
      
      {% if registros %}
        <div class="table-responsive">
          <table class="table table-hover admin-table registros-table">
            <thead>
              <tr>
                <th width="3%">#</th>
                <th width="15%">Nombre Completo</th>
                <th width="15%">Email</th>
                <th width="10%">Teléfono</th>
                <th width="12%">Institución</th>
                <th width="10%">Área</th>
                <th width="15%">Intereses</th>
                <th width="5%">Consent.</th>
                <th width="10%">Asistencia</th>
                <th width="5%">IP</th>
              </tr>
            </thead>
            <tbody>
              {% for r in registros %}
              <tr>
                <td>{{ loop.index }}</td>
                <td class="fw-semibold">{{ r.nombre }} {{ r.apellidos }}</td>
                <td>
                  <a href="mailto:{{ r.email }}" class="text-decoration-none">
                    <i class="fas fa-envelope"></i> {{ r.email }}
                  </a>
                </td>
                <td>{{ r.telefono or "—" }}</td>
                <td>{{ r.institucion or "—" }}</td>
                <td>{{ r.carrera_o_area or "—" }}</td>
                <td>
                  {% if r.temas_interes %}
                    <small>{{ r.temas_interes[:50] }}{% if r.temas_interes|length > 50 %}...{% endif %}</small>
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if r.consentimiento %}
                    <i class="fas fa-check-circle text-success"></i>
                  {% else %}
                    <i class="fas fa-times-circle text-danger"></i>
                  {% endif %}
                </td>
                <td>
                  <small>{{ r.asistencia_marcarda_en or r.creado_en }}</small>
                </td>
                <td>
                  <small class="text-muted">{{ r.ip or "—" }}</small>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <!-- Resumen estadístico -->
        <div class="stats-summary mt-4">
          <div class="row text-center">
            <div class="col-md-3">
              <div class="stat-card">
                <i class="fas fa-user-check fa-2x text-primary mb-2"></i>
                <h4>{{ registros|length }}</h4>
                <p class="text-muted">Total Registros</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card">
                <i class="fas fa-thumbs-up fa-2x text-success mb-2"></i>
                <h4>{{ registros|selectattr('consentimiento')|list|length }}</h4>
                <p class="text-muted">Con Consentimiento</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card">
                <i class="fas fa-building fa-2x text-info mb-2"></i>
                <h4>{{ registros|selectattr('institucion')|list|length }}</h4>
                <p class="text-muted">Con Institución</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card">
                <i class="fas fa-phone fa-2x text-warning mb-2"></i>
                <h4>{{ registros|selectattr('telefono')|list|length }}</h4>
                <p class="text-muted">Con Teléfono</p>
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <div class="alert alert-info text-center py-5">
          <i class="fas fa-info-circle fa-3x mb-3"></i>
          <h5>No hay registros para este evento</h5>
          <p class="mb-0">Los registros aparecerán aquí cuando los participantes se registren.</p>
        </div>
      {% endif %}
    </div>
    {% endif %}

  {% endif %}

  <style>
    /* Estilos específicos para el panel de administración */
    .admin-header {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: var(--shadow-light);
      border-left: 5px solid var(--primary-color);
    }

    .admin-title {
      color: var(--primary-color);
      font-size: 2rem;
      font-weight: 700;
      margin: 0;
    }

    .admin-title i {
      margin-right: 0.5rem;
      opacity: 0.8;
    }

    .section-title {
      color: var(--primary-color);
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--border-color);
    }

    .section-title i {
      margin-right: 0.5rem;
      opacity: 0.7;
    }

    .filter-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }

    .admin-table {
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    .admin-table thead {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .admin-table thead th {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: none;
      letter-spacing: normal;
      padding: 1rem;
      border-bottom: 2px solid var(--border-color);
    }

    .admin-table tbody td {
      padding: 0.75rem 1rem;
      vertical-align: middle;
      color: var(--text-primary);
    }

    .admin-table tbody tr:hover {
      background-color: rgba(44, 90, 160, 0.05);
    }

    .table-active {
      background-color: rgba(40, 167, 69, 0.1) !important;
    }

    .event-slug {
      background: #f8f9fa;
      padding: 0.25rem 0.5rem;
      border-radius: 5px;
      font-size: 0.875rem;
      color: var(--secondary-color);
    }

    .registros-table {
      font-size: 0.9rem;
    }

    .stats-summary {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }

    .stat-card {
      padding: 1rem;
      background: white;
      border-radius: 10px;
      box-shadow: var(--shadow-light);
    }

    .stat-card h4 {
      color: var(--primary-color);
      font-weight: 700;
      margin: 0.5rem 0;
    }

    .stat-card p {
      margin: 0;
      font-size: 0.875rem;
    }

    /* Mejoras en los badges */
    .badge {
      padding: 0.35rem 0.75rem;
      font-weight: 500;
      font-size: 0.8rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-header .col-md-6 {
        text-align: center !important;
      }
      
      .admin-title {
        font-size: 1.5rem;
      }
      
      .section-title {
        font-size: 1.25rem;
      }
      
      .filter-section .col-md-3,
      .filter-section .col-md-6 {
        margin-bottom: 1rem;
      }
      
      .admin-table {
        font-size: 0.8rem;
      }
      
      .stat-card {
        margin-bottom: 1rem;
      }
    }

    /* Animaciones suaves */
    .form-section,
    .admin-header {
      animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Mejora visual de botones */
    .btn-outline-success:hover,
    .btn-outline-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
  </style>
{% endblock %}